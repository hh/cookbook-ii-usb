#!/bin/sh
exec > >(tee /early_command.log | logger -t early-command -s 2>/dev/console ) 2>&1
set +e -x
# /cdrom mounted iso
# /isodevice usb stick
# /target does NOT exist yet
# to run this you need
# d-i partman/early_command string bash /isodevice/prepartitioning_command.sh
# it is picked up by the partman plugin of ubiquity

# These helped me debug:
# ls -laR / > /root-ls-from-prepartitioning.txt
# df > /df-from-prepartitioning.txt

dpkg -i /isodevice/cache/<%=::File.basename(node['ii-usb']['chef-deb']['src']['cache'])%>

# Chef-client here could do interesting things to modify the install process
# ie the debconf values driving the install

chvt 9
chef-solo -c /isodevice/ubiquity-early-solo.rb 2>&1 | tee /dev/tty9 | tee /chef-solo-early.log
sleep 5
chvt 7
#export DISPLAY=:0.0
#gnome-terminal -t debug-terminal
#gnome-terminal -t early-chef -e 'tail -F /chef-solo-early.log'

#chef-client -c /isodevice/ubiquity-early-client.rb
